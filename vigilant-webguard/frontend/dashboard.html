<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vigilant WebGuard - SOC Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    .animate-pulse-fast {
      animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    .glow {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }
    .sidebar-active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col">
      <div class="p-4">
        <h1 class="text-xl font-bold text-blue-400 mb-6">🛡️ Vigilant WebGuard</h1>
        <nav class="space-y-2 text-sm">
          <a href="#overview" onclick="showSection('overview')" class="nav-link block py-2 px-3 rounded hover:bg-gray-700 transition-colors">📊 Dashboard Principal</a>
          <a href="#realtime" onclick="showSection('realtime')" class="nav-link block py-2 px-3 rounded hover:bg-gray-700 transition-colors">⚡ Monitoreo Tiempo Real</a>
          <a href="#threats" onclick="showSection('threats')" class="nav-link block py-2 px-3 rounded hover:bg-gray-700 transition-colors">🎯 Inteligencia de Amenazas</a>
          <a href="#incidents" onclick="showSection('incidents')" class="nav-link block py-2 px-3 rounded hover:bg-gray-700 transition-colors">🚨 Gestión de Incidentes</a>
          <a href="#compliance" onclick="showSection('compliance')" class="nav-link block py-2 px-3 rounded hover:bg-gray-700 transition-colors">✅ Cumplimiento</a>
          <a href="#advanced" onclick="showSection('advanced')" class="nav-link block py-2 px-3 rounded hover:bg-gray-700 transition-colors">🔬 Análisis Avanzado</a>
          <a href="./index.html" class="nav-link block py-2 px-3 rounded hover:bg-gray-700 transition-colors">🔍 Escáner Web</a>
        </nav>
      </div>
      <div class="mt-auto p-4 text-xs text-gray-400">
        <div>🟢 Sistema Operativo</div>
        <div>📡 Conectado al SOC</div>
        <div id="lastUpdate">🕒 Actualizado hace 2s</div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
      <!-- Header -->
      <header class="bg-gray-800 border-b border-gray-700 p-4">
        <div class="flex justify-between items-center">
          <div>
            <h2 id="sectionTitle" class="text-2xl font-semibold">Dashboard Principal</h2>
            <p class="text-gray-400 text-sm">Monitoreo de seguridad en tiempo real</p>
          </div>
          <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
              <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
              <span class="text-sm text-gray-300">Estado: Operativo</span>
            </div>
            <div id="currentTime" class="text-sm text-gray-300"></div>
          </div>
        </div>
      </header>

      <!-- Overview Section -->
      <section id="overview" class="section-content p-6">
        <!-- KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-400 text-sm">Conexiones Activas</p>
                <p id="activeConnections" class="text-3xl font-bold text-blue-400">0</p>
              </div>
              <div class="text-blue-400 text-3xl">🔗</div>
            </div>
          </div>
          
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-400 text-sm">Alertas Críticas</p>
                <p id="criticalAlerts" class="text-3xl font-bold text-red-400">0</p>
              </div>
              <div class="text-red-400 text-3xl">⚠️</div>
            </div>
          </div>
          
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-400 text-sm">IPs Únicas</p>
                <p id="uniqueIPs" class="text-3xl font-bold text-green-400">0</p>
              </div>
              <div class="text-green-400 text-3xl">🌐</div>
            </div>
          </div>
          
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-400 text-sm">Tráfico Sospechoso</p>
                <p id="suspiciousTraffic" class="text-3xl font-bold text-yellow-400">0</p>
              </div>
              <div class="text-yellow-400 text-3xl">⚡</div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- Traffic Chart -->
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h3 class="text-lg font-semibold mb-4">📈 Tráfico de Red (Último Hora)</h3>
            <div class="h-64">
              <canvas id="trafficChart"></canvas>
            </div>
          </div>
          
          <!-- Attacks by Country -->
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h3 class="text-lg font-semibold mb-4">🌍 Ataques por País</h3>
            <div class="h-64">
              <canvas id="countryChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Recent Alerts -->
        <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
          <h3 class="text-lg font-semibold mb-4">🚨 Alertas Recientes</h3>
          <div id="recentAlerts" class="space-y-3">
            <!-- Alertas se cargarán dinámicamente -->
          </div>
        </div>
      </section>

      <!-- Real-time Monitoring Section -->
      <section id="realtime" class="section-content p-6 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <!-- Live Traffic Feed -->
          <div class="lg:col-span-2 bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h3 class="text-lg font-semibold mb-4">🔴 Feed de Tráfico en Vivo</h3>
            <div id="liveTrafficFeed" class="h-96 overflow-y-auto space-y-2 font-mono text-sm">
              <!-- Traffic feed se cargará aquí -->
            </div>
          </div>
          
          <!-- System Resources -->
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h3 class="text-lg font-semibold mb-4">⚙️ Recursos del Sistema</h3>
            <div class="space-y-4">
              <div>
                <div class="flex justify-between text-sm">
                  <span>CPU</span>
                  <span id="cpuUsage">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                  <div id="cpuBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
              </div>
              
              <div>
                <div class="flex justify-between text-sm">
                  <span>Memoria</span>
                  <span id="memoryUsage">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                  <div id="memoryBar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
              </div>
              
              <div>
                <div class="flex justify-between text-sm">
                  <span>Disco</span>
                  <span id="diskUsage">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                  <div id="diskBar" class="bg-yellow-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Attack Map -->
        <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
          <h3 class="text-lg font-semibold mb-4">🗺️ Mapa de Ataques en Tiempo Real</h3>
        <div id="attackMap" class="h-96 bg-gray-900 rounded"></div>
        </div>
      </section>

      <!-- Threat Intelligence Section -->
      <section id="threats" class="section-content p-6 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- Active Campaigns -->
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h3 class="text-lg font-semibold mb-4">🎯 Campañas Activas</h3>
            <div id="activeCampaigns" class="space-y-4">
              <!-- Campañas se cargarán aquí -->
            </div>
          </div>
          
          <!-- Trending Malware -->
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h3 class="text-lg font-semibold mb-4">🦠 Malware en Tendencia</h3>
            <div id="trendingMalware" class="space-y-3">
              <!-- Malware trending se cargará aquí -->
            </div>
          </div>
        </div>
        
        <!-- CVE Alerts -->
        <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
          <h3 class="text-lg font-semibold mb-4">🔥 Alertas de Vulnerabilidades</h3>
          <div id="cveAlerts" class="space-y-3">
            <!-- CVE alerts se cargarán aquí -->
          </div>
        </div>
      </section>

      <!-- Incidents Section -->
      <section id="incidents" class="section-content p-6 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <!-- Active Incidents -->
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h3 class="text-lg font-semibold mb-4 text-red-400">🚨 Incidentes Activos</h3>
            <div id="activeIncidents" class="space-y-3">
              <!-- Incidentes activos -->
            </div>
          </div>
          
          <!-- Recent Incidents -->
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h3 class="text-lg font-semibold mb-4">📋 Incidentes Recientes</h3>
            <div id="recentIncidents" class="space-y-3">
              <!-- Incidentes recientes -->
            </div>
          </div>
          
          <!-- Response Metrics -->
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h3 class="text-lg font-semibold mb-4">📊 Métricas de Respuesta</h3>
            <div id="responseMetrics" class="space-y-3">
              <!-- Métricas -->
            </div>
          </div>
        </div>
      </section>

      <!-- Compliance Section -->
      <section id="compliance" class="section-content p-6 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- Compliance Frameworks -->
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h3 class="text-lg font-semibold mb-4">✅ Marcos de Cumplimiento</h3>
            <div id="complianceFrameworks" class="space-y-4">
              <!-- Frameworks -->
            </div>
          </div>
          
          <!-- Risk Assessment -->
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h3 class="text-lg font-semibold mb-4">⚖️ Evaluación de Riesgos</h3>
            <div class="h-64">
              <canvas id="riskChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Advanced Analysis Section -->
      <section id="advanced" class="section-content p-6 hidden">
        <div class="mb-8">
          <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h3 class="text-lg font-semibold mb-4">🔬 Análisis Completo de URL</h3>
            <div class="flex space-x-4 mb-4">
              <input id="advancedUrl" type="url" placeholder="https://ejemplo.com" class="flex-1 p-3 bg-gray-700 border border-gray-600 rounded text-white">
              <button onclick="performAdvancedScan()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded font-semibold">🚀 Análisis Profundo</button>
            </div>
            <div id="advancedResults" class="hidden">
              <!-- Resultados del análisis avanzado -->
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Estado global
    let currentSection = 'overview';
    let updateInterval;
    
    // Variables del mapa
    let attackMap;
    let attackMarkers = [];
    
    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
      updateCurrentTime();
      startRealTimeUpdates();
      showSection('overview');
      initializeAttackMap();
    });
    
    // Inicializar mapa de ataques
    function initializeAttackMap() {
      try {
        attackMap = L.map('attackMap').setView([20, 0], 2);
        
        // Usar tile layer oscuro
        L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>',
          maxZoom: 18
        }).addTo(attackMap);
        
        // Iniciar simulación de ataques
        startAttackSimulation();
        
      } catch (error) {
        console.error('Error inicializando mapa:', error);
        document.getElementById('attackMap').innerHTML = '<div class="flex items-center justify-center h-full text-gray-400">Error cargando mapa</div>';
      }
    }
    
    // Simular ataques en tiempo real
    function startAttackSimulation() {
      setInterval(() => {
        if (Math.random() < 0.7) { // 70% probabilidad cada 3 segundos
          simulateAttack();
        }
      }, 3000);
    }
    
    // Simular un ataque
    function simulateAttack() {
      const attackTypes = [
        { type: 'XSS', color: '#ef4444' },
        { type: 'SQL_INJECTION', color: '#dc2626' },
        { type: 'MALICIOUS_IP', color: '#f97316' },
        { type: 'DIRECTORY_TRAVERSAL', color: '#a855f7' },
        { type: 'BRUTE_FORCE', color: '#eab308' }
      ];
      
      const countries = [
        { name: 'China', lat: 35.8617, lng: 104.1954 },
        { name: 'Rusia', lat: 61.5240, lng: 105.3188 },
        { name: 'Estados Unidos', lat: 37.0902, lng: -95.7129 },
        { name: 'Brasil', lat: -14.2350, lng: -51.9253 },
        { name: 'India', lat: 20.5937, lng: 78.9629 },
        { name: 'Alemania', lat: 51.1657, lng: 10.4515 }
      ];
      
      const attack = attackTypes[Math.floor(Math.random() * attackTypes.length)];
      const country = countries[Math.floor(Math.random() * countries.length)];
      
      // Añadir ruido a las coordenadas
      const lat = country.lat + (Math.random() - 0.5) * 10;
      const lng = country.lng + (Math.random() - 0.5) * 10;
      
      // Crear marcador en el mapa
      const marker = L.circleMarker([lat, lng], {
        color: attack.color,
        fillColor: attack.color,
        fillOpacity: 0.8,
        radius: 8,
        className: 'attack-marker'
      }).addTo(attackMap);
      
      // Popup con información del ataque
      marker.bindPopup(`
        <div style="color: #1f2937;">
          <strong>${attack.type.replace('_', ' ')}</strong><br>
          País: ${country.name}<br>
          Hora: ${new Date().toLocaleTimeString()}
        </div>
      `);
      
      // Añadir a la lista de marcadores
      attackMarkers.push(marker);
      
      // Remover marcadores antiguos (mantener solo 30)
      if (attackMarkers.length > 30) {
        const oldMarker = attackMarkers.shift();
        attackMap.removeLayer(oldMarker);
      }
      
      // Animación de aparición
      marker.setStyle({ radius: 15 });
      setTimeout(() => {
        marker.setStyle({ radius: 8 });
      }, 500);
    }
    
    // Gestión de secciones
    function showSection(sectionId) {
      // Ocultar todas las secciones
      document.querySelectorAll('.section-content').forEach(section => {
        section.classList.add('hidden');
      });
      
      // Mostrar sección seleccionada
      document.getElementById(sectionId).classList.remove('hidden');
      
      // Actualizar navegación
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('sidebar-active');
      });
      
      event.target.classList.add('sidebar-active');
      
      // Actualizar título
      const titles = {
        'overview': 'Dashboard Principal',
        'realtime': 'Monitoreo en Tiempo Real',
        'threats': 'Inteligencia de Amenazas',
        'incidents': 'Gestión de Incidentes',
        'compliance': 'Cumplimiento Normativo',
        'advanced': 'Análisis Avanzado'
      };
      
      document.getElementById('sectionTitle').textContent = titles[sectionId];
      currentSection = sectionId;
      
      // Cargar datos específicos de la sección
      loadSectionData(sectionId);
    }
    
    // Actualizar tiempo actual
    function updateCurrentTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleTimeString();
    }
    
    // Iniciar actualizaciones en tiempo real
    function startRealTimeUpdates() {
      updateInterval = setInterval(() => {
        updateCurrentTime();
        updateDashboardData();
        updateLastUpdateTime();
      }, 2000);
    }
    
    // Actualizar datos del dashboard
    async function updateDashboardData() {
      try {
        const response = await fetch('/api/dashboard/realtime-stats');
        const stats = await response.json();
        
        // Actualizar KPIs
        document.getElementById('activeConnections').textContent = stats.current_connections || 0;
        document.getElementById('uniqueIPs').textContent = stats.unique_ips || 0;
        document.getElementById('suspiciousTraffic').textContent = stats.suspicious_requests || 0;
        document.getElementById('criticalAlerts').textContent = stats.recent_alerts || 0;
        
        // Actualizar gráficos si estamos en la sección principal
        if (currentSection === 'overview') {
          updateCharts(stats);
        }
        
        // Actualizar feed en tiempo real si estamos en esa sección
        if (currentSection === 'realtime') {
          updateRealTimeFeed();
        }
        
      } catch (error) {
        console.error('Error actualizando datos:', error);
      }
    }
    
    // Actualizar tiempo de última actualización
    function updateLastUpdateTime() {
      document.getElementById('lastUpdate').textContent = '🕒 Actualizado ahora';
    }
    
    // Cargar datos específicos de cada sección
    async function loadSectionData(sectionId) {
      switch(sectionId) {
        case 'threats':
          await loadThreatIntelligence();
          break;
        case 'incidents':
          await loadIncidentData();
          break;
        case 'compliance':
          await loadComplianceData();
          break;
        case 'realtime':
          await loadSystemMetrics();
          break;
      }
    }
    
    // Funciones de carga de datos
    async function loadThreatIntelligence() {
      try {
        const response = await fetch('/api/dashboard/threat-intelligence');
        const data = await response.json();
        
        // Mostrar campañas activas
        const campaignsContainer = document.getElementById('activeCampaigns');
        campaignsContainer.innerHTML = data.active_campaigns.map(campaign => `
          <div class="p-4 bg-gray-700 rounded border-l-4 border-red-500">
            <h4 class="font-semibold text-red-400">${campaign.name}</h4>
            <p class="text-sm text-gray-300">${campaign.targets.join(', ')}</p>
            <div class="mt-2">
              <span class="inline-block px-2 py-1 text-xs bg-red-600 rounded">${campaign.severity}</span>
            </div>
          </div>
        `).join('');
        
        // Mostrar malware trending
        const malwareContainer = document.getElementById('trendingMalware');
        malwareContainer.innerHTML = data.trending_malware.map(malware => `
          <div class="flex items-center justify-between p-3 bg-gray-700 rounded">
            <span class="font-medium">${malware}</span>
            <span class="text-sm text-red-400">🔥 Trending</span>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error cargando threat intelligence:', error);
      }
    }
    
    async function loadIncidentData() {
      try {
        const response = await fetch('/api/dashboard/incident-response');
        const data = await response.json();
        
        // Mostrar incidentes activos
        const activeContainer = document.getElementById('activeIncidents');
        activeContainer.innerHTML = data.active_incidents.map(incident => `
          <div class="p-4 bg-red-900 bg-opacity-50 border border-red-700 rounded">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-semibold">${incident.title}</h4>
                <p class="text-sm text-gray-300">${incident.id}</p>
              </div>
              <span class="px-2 py-1 text-xs bg-red-600 rounded">${incident.severity}</span>
            </div>
            <p class="text-sm text-gray-400 mt-2">Asignado a: ${incident.assigned_to}</p>
          </div>
        `).join('');
        
        // Mostrar métricas
        const metricsContainer = document.getElementById('responseMetrics');
        metricsContainer.innerHTML = `
          <div class="space-y-3">
            <div class="flex justify-between">
              <span>MTTR</span>
              <span class="text-blue-400">${data.response_metrics.mttr}</span>
            </div>
            <div class="flex justify-between">
              <span>MTTA</span>
              <span class="text-green-400">${data.response_metrics.mtta}</span>
            </div>
            <div class="flex justify-between">
              <span>Incidentes este mes</span>
              <span class="text-yellow-400">${data.response_metrics.incidents_this_month}</span>
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Error cargando datos de incidentes:', error);
      }
    }
    
    async function loadComplianceData() {
      try {
        const response = await fetch('/api/dashboard/compliance-status');
        const data = await response.json();
        
        // Mostrar frameworks
        const frameworksContainer = document.getElementById('complianceFrameworks');
        frameworksContainer.innerHTML = Object.entries(data.frameworks).map(([name, info]) => `
          <div class="p-4 bg-gray-700 rounded">
            <div class="flex justify-between items-center mb-2">
              <h4 class="font-semibold">${name.replace('_', ' ')}</h4>
              <span class="px-2 py-1 text-xs rounded ${
                info.status === 'COMPLIANT' ? 'bg-green-600' : 'bg-yellow-600'
              }">${info.status}</span>
            </div>
            <div class="text-sm text-gray-300">
              Puntuación: ${info.score}/100
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error cargando datos de cumplimiento:', error);
      }
    }
    
    async function loadSystemMetrics() {
      try {
        const response = await fetch('/api/dashboard/security-metrics');
        const data = await response.json();
        
        // Actualizar barras de recursos
        const health = data.system_health;
        document.getElementById('cpuUsage').textContent = `${health.cpu_usage}%`;
        document.getElementById('cpuBar').style.width = `${health.cpu_usage}%`;
        
        document.getElementById('memoryUsage').textContent = `${health.memory_usage}%`;
        document.getElementById('memoryBar').style.width = `${health.memory_usage}%`;
        
        document.getElementById('diskUsage').textContent = `${health.disk_usage}%`;
        document.getElementById('diskBar').style.width = `${health.disk_usage}%`;
        
      } catch (error) {
        console.error('Error cargando métricas del sistema:', error);
      }
    }
    
    // Actualizar feed en tiempo real
    function updateRealTimeFeed() {
      const feed = document.getElementById('liveTrafficFeed');
      
      // Simular entrada de tráfico
      const entry = document.createElement('div');
      entry.className = 'p-2 bg-gray-700 rounded text-xs border-l-2 border-blue-500';
      
      const timestamp = new Date().toLocaleTimeString();
      const ips = ['192.168.1.100', '10.0.0.50', '172.16.0.25', '203.0.113.45'];
      const paths = ['/', '/admin', '/login', '/api/users', '/wp-admin'];
      
      const randomIP = ips[Math.floor(Math.random() * ips.length)];
      const randomPath = paths[Math.floor(Math.random() * paths.length)];
      
      entry.innerHTML = `
        <span class="text-gray-400">[${timestamp}]</span>
        <span class="text-blue-400">${randomIP}</span>
        <span class="text-green-400">GET</span>
        <span class="text-yellow-400">${randomPath}</span>
        <span class="text-gray-300">200</span>
      `;
      
      feed.insertBefore(entry, feed.firstChild);
      
      // Mantener solo las últimas 50 entradas
      while (feed.children.length > 50) {
        feed.removeChild(feed.lastChild);
      }
    }
    
    // Función para análisis avanzado
    async function performAdvancedScan() {
      const url = document.getElementById('advancedUrl').value;
      if (!url) {
        alert('Por favor ingresa una URL');
        return;
      }
      
      const resultsContainer = document.getElementById('advancedResults');
      resultsContainer.classList.remove('hidden');
      resultsContainer.innerHTML = '<p class="text-blue-400">🔍 Realizando análisis profundo...</p>';
      
      try {
        const response = await fetch('/api/dashboard/comprehensive-scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        
        const results = await response.json();
        
        resultsContainer.innerHTML = `
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
            <div class="bg-gray-700 p-4 rounded">
              <h4 class="font-semibold mb-2">🎯 Puntuación de Riesgo</h4>
              <div class="text-2xl font-bold ${
                results.risk_score > 70 ? 'text-red-400' : 
                results.risk_score > 40 ? 'text-yellow-400' : 'text-green-400'
              }">${results.risk_score}/100</div>
              <div class="text-sm">${results.risk_level}</div>
            </div>
            
            <div class="bg-gray-700 p-4 rounded">
              <h4 class="font-semibold mb-2">🔒 Certificado SSL</h4>
              <div class="text-sm">
                <p>Estado: ${results.ssl_certificate.error ? 'Error' : 'Válido'}</p>
                <p>Emisor: ${results.ssl_certificate.issuer?.organizationName || 'N/A'}</p>
              </div>
            </div>
            
            <div class="bg-gray-700 p-4 rounded">
              <h4 class="font-semibold mb-2">🌐 Información IP</h4>
              <div class="text-sm">
                <p>IP: ${results.ip_reputation.ip}</p>
                <p>País: ${results.ip_reputation.country}</p>
                <p>ASN: ${results.ip_reputation.asn}</p>
              </div>
            </div>
            
            <div class="bg-gray-700 p-4 rounded">
              <h4 class="font-semibold mb-2">🔧 Tecnologías</h4>
              <div class="text-sm">
                <p>Servidor: ${results.web_technologies.server}</p>
                <p>Framework: ${results.web_technologies.framework}</p>
                <p>CMS: ${results.web_technologies.cms}</p>
              </div>
            </div>
          </div>
        `;
        
      } catch (error) {
        resultsContainer.innerHTML = '<p class="text-red-400">❌ Error en el análisis</p>';
      }
    }
    
    // Función para actualizar gráficos
    function updateCharts(stats) {
      // Actualizar gráfico de tráfico
      // Aquí se implementarían los gráficos reales con Chart.js
    }
  </script>
</body>
</html>

